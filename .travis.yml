language: php

sudo: false

cache:
    directories:
        - $HOME/.composer/cache/files

php: [7.0, 7.1, 7.2]

env:
    global:
        - WEBDRIVER=selenium

matrix:
    fast_finish: true
    include:
        -   php: 7.0
            env:
                - WEBDRIVER=selenium-remote-firefox
                - WEB_FIXTURES_BROWSER=firefox
                - DRIVER_OPTIONS='{}'
            sudo: required
            services:
                - docker
        -   php: 7.0
            env:
                - WEBDRIVER=selenium-remote-chrome
                - WEB_FIXTURES_BROWSER=chrome
                - DRIVER_OPTIONS='{"chromeOptions":{"args":["no-sandbox","dbus-stub","disable-dev-shm-usage","reduce-security-for-testing","allow-insecure-localhost","enable-logging","disable-setuid-sandbox","disable-gpu","disable-web-security","disk-cache-size=1","allow-running-insecure-content","ignore-certificate-errors","ignore-urlfetcher-cert-requests"]}}'
            sudo: required
            services:
                - docker

before_script:
    - sh bin/run-"$WEBDRIVER".sh

    - composer install

    # Start a webserver for web fixtures.
    - vendor/bin/mink-test-server > /dev/null 2>&1 &

script: phpunit -v --coverage-clover=coverage.clover

after_script:
    - wget https://scrutinizer-ci.com/ocular.phar
    - php ocular.phar code-coverage:upload --format=php-clover coverage.clover

after_failure:
    - cat /tmp/webdriver_output.txt
